# Sequential PR validation workflow with coverage gating
# Stage 1: Linux tests with 90% coverage requirement
# Stage 2: Windows .NET Core and .NET Framework tests (only if Linux passes)
# Stage 3: macOS tests (only if Stage 2 passes)
#
# SECURITY NOTE:
# - Uses pull_request_target to run workflow from the trusted main branch, not from the PR branch
# - This prevents malicious workflow YAML changes in untrusted PR branches from taking effect
# - All checkout steps use PR refs (refs/pull/*/head) to check out PR code from the base repo
# - persist-credentials: false prevents the checkout token from being written to git config for subsequent git commands
#   (it does NOT, by itself, prevent steps from accessing github.token / GITHUB_TOKEN if you explicitly expose it)
# - Default GITHUB_TOKEN permissions are restricted to read-only repository contents to limit impact if exposed

name: PR Checks v3 (Gated)

permissions:
  contents: read
  
on:
  pull_request_target:  # Runs from the main branch, not from PR branch
    branches:
      - main
jobs:
  # ============================================================================
  # DETECTION: Check if .csproj files exist
  # ============================================================================
  detect-projects:
    name: "Detect .NET Projects"
    runs-on: ubuntu-latest
    if: github.repository != 'Chris-Wolfgang/repo-template'
    outputs:
      has-projects: ${{ steps.check-projects.outputs.has-projects }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/head
          persist-credentials: false
      
      - name: Check for .NET project files
        id: check-projects
        run: |
          if git ls-files '*.csproj' '*.vbproj' '*.fsproj' | grep -q .; then
            echo "has-projects=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Found .NET project files - .NET build and test jobs will run"
          else
            echo "has-projects=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No .NET project files found - skipping .NET build and test jobs"
          fi

  # ============================================================================
  # STAGE 1: Linux - .NET Core/5+ Tests with Coverage Gate
  # ============================================================================
  test-linux-core: 
    name: "Stage 1: Linux Tests (.NET 5.0-10.0) + Coverage Gate"
    runs-on:  ubuntu-latest
    needs: detect-projects
    if: github.repository != 'Chris-Wolfgang/repo-template' && needs.detect-projects.outputs.has-projects == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/head
          persist-credentials: false

      # Fix for .NET 5.0 on Ubuntu 22.04+ - install libssl1.1
      - name: Install OpenSSL 1.1 for .NET 5.0
        run: |
          wget http://archive.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1f-1ubuntu2_amd64.deb
          sudo dpkg -i libssl1.1_1.1.1f-1ubuntu2_amd64.deb

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            5.0.x
            6.0.x
            7.0.x
            8.0.x
            9.0.x
            10.0.x

      - name: Restore and build (exclude .NET Framework-only projects)
        run: |
          echo "Finding .NET project files in repository (via find command)..."
          
          # Filter out projects that ONLY target .NET Framework 4.x
          # Multi-targeting projects (e.g., net8.0;net48) will be INCLUDED
          projects=()
          project_found=false
          
          while IFS= read -r -d '' proj; do
            project_found=true
            # Check if project has any .NET 5+ target framework
            # Look for: net5.0, net6.0, net7.0, net8.0, net9.0, net10.0, or netcoreapp, netstandard
            if grep -qE '<TargetFramework[s]?>.*(net(5\.0|6\.0|7\.0|8\.0|9\.0|10\.0)|netcoreapp|netstandard)' "$proj"; then
              projects+=("$proj")
              echo "‚úì Including: $proj (has .NET 5+ or .NET Core target)"
            else
              echo "‚äò Excluding: $proj (Framework-only, incompatible with Linux)"
            fi
          done < <(find . -type f \( -name "*.csproj" -o -name "*.vbproj" -o -name "*.fsproj" \) -print0)
          
          if [ "$project_found" = false ]; then
            echo "‚ùå No .NET projects found."
            echo "This should not occur as detect-projects already verified project existence."
            exit 1
          fi
          
          if [ ${#projects[@]} -eq 0 ]; then
            echo "‚ùå No compatible .NET projects found."
            echo "All projects target only .NET Framework 4.x, which is incompatible with Linux."
            exit 1
          fi
          
          echo ""
          echo "=========================================="
          echo "Projects to build:"
          echo "=========================================="
          printf '%s\n' "${projects[@]}"
          echo ""
          
          # Restore each project
          echo "Restoring projects..."
          for proj in "${projects[@]}"; do
            echo "Restoring: $proj"
            dotnet restore "$proj" || exit 1
          done
          
          echo ""
          echo "Building projects..."
          # Build each project, handling multi-targeting projects
          # For multi-targeting projects, build only Linux-compatible frameworks (.NET 5.0+, .NET Core, .NET Standard)
          for proj in "${projects[@]}"; do
            echo "Building: $proj"
            
            # Extract target frameworks from the project file
            # Support both <TargetFramework> (single) and <TargetFrameworks> (multiple)
            frameworks=$(grep -oP '<TargetFramework[s]?>\K[^<]+' "$proj" | tr ';' '\n' | grep -E '^(net(5\.0|6\.0|7\.0|8\.0|9\.0|10\.0)|netcoreapp[0-9.]+|netstandard[0-9.]+)$' || true)
            
            if [ -z "$frameworks" ]; then
              echo "‚ö†Ô∏è  No Linux-compatible frameworks found in $proj"
              continue
            fi
            
            # Check if this is a multi-targeting project
            framework_count=$(echo "$frameworks" | wc -l)
            
            if [ "$framework_count" -eq 1 ]; then
              # Single target framework - build normally
              echo "  Target framework: $frameworks"
              dotnet build "$proj" --no-restore --configuration Release || exit 1
            else
              # Multi-targeting project - build each compatible framework separately
              echo "  Target frameworks (multi-targeting): $(echo "$frameworks" | tr '\n' ' ')"
              while IFS= read -r fw; do
                [ -z "$fw" ] && continue
                echo "  Building framework: $fw"
                dotnet build "$proj" --no-restore --configuration Release --framework "$fw" || exit 1
              done <<< "$frameworks"
            fi
          done
          
          echo ""
          echo "‚úÖ All compatible projects built successfully"

      - name: Run tests with coverage (.NET Core 5.0 - 10.0)
        run: |
          # Find all test projects (C#, VB.NET, F#)
          mapfile -t test_projects < <(find ./tests -type f \( -name "*.csproj" -o -name "*.vbproj" -o -name "*.fsproj" \))
          
          if [ ${#test_projects[@]} -eq 0 ]; then
            echo "‚ùå No test projects found in ./tests directory!"
            exit 1
          fi
          
          echo "=========================================="
          echo "Found test projects:"
          echo "=========================================="
          printf '%s\n' "${test_projects[@]}"
          echo ""
          
          for test_proj in "${test_projects[@]}"; do
            echo "=========================================="
            echo "Testing project: $test_proj"
            echo "=========================================="
            
            # Extract target frameworks from the project file
            # Support both <TargetFramework> (single) and <TargetFrameworks> (multiple)
            frameworks=$(grep -oP '<TargetFramework[s]?>\K[^<]+' "$test_proj" | tr ';' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -E '^net(5\.0|6\.0|7\.0|8\.0|9\.0|10\.0)$' || true)
            
            if [ -z "$frameworks" ]; then
              echo "‚äò Skipping: No compatible .NET 5.0-10.0 target frameworks found"
              echo ""
              continue
            fi
            
            echo "Target frameworks: $(echo "$frameworks" | tr '\n' ' ')"
            echo ""
            
            # Test each framework that the project actually targets
            while IFS= read -r fw; do
              [ -z "$fw" ] && continue
              echo "Testing framework: $fw"
              
              dotnet test "$test_proj" \
                --configuration Release \
                --framework "$fw" \
                --collect:"XPlat Code Coverage" \
                --results-directory "./TestResults" \
                --logger "console;verbosity=minimal" || exit 1
            done <<< "$frameworks"
            echo ""
          done

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Generate coverage report
        run: |
          reportgenerator \
            -reports:"TestResults/**/coverage.cobertura.xml" \
            -targetdir:"CoverageReport" \
            -reporttypes:"Html;TextSummary;MarkdownSummaryGithub;CsvSummary"

      - name: Enforce 90% coverage threshold
        run: |
          if [ ! -f CoverageReport/Summary.txt ]; then
            echo "‚ùå Coverage report not generated!"
            exit 1
          fi

          echo "Coverage Summary:"
          cat CoverageReport/Summary.txt
          echo ""
          
          failed_projects=""
          threshold=90
          
          while read -r line; do
            # Match lines with module names and percentages
            if echo "$line" | grep -qE '^[^ ].*[0-9]+%$' && ! echo "$line" | grep -q '^Summary'; then
              module=$(echo "$line" | awk '{print $1}')
              percent=$(echo "$line" | awk '{print $NF}' | tr -d '%')
              
              echo "Checking module: '$module' - Coverage: ${percent}%"
              
              if [ "$percent" -lt "$threshold" ]; then
                echo "  ‚ùå FAIL: Below ${threshold}% threshold"
                failed_projects="$failed_projects $module (${percent}%)"
              else
                echo "  ‚úÖ PASS: Meets ${threshold}% threshold"
              fi
            fi
          done < CoverageReport/Summary.txt

          if [ -n "$failed_projects" ]; then
            echo ""
            echo "=========================================="
            echo "‚ùå COVERAGE GATE FAILED"
            echo "=========================================="
            echo "Projects below ${threshold}% coverage: $failed_projects"
            echo ""
            echo "Stage 1 failed. Windows, macOS, and .NET Framework tests will NOT run."
            exit 1
          else
            echo ""
            echo "=========================================="
            echo "‚úÖ COVERAGE GATE PASSED"
            echo "=========================================="
            echo "All projects meet ${threshold}% coverage threshold."
            echo "Proceeding to Stage 2 (Windows and macOS tests)."
          fi

      - name: Upload Linux coverage results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-linux
          path: |
            TestResults/
            CoverageReport/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            src/**/bin/Release
            tests/**/bin/Release

  # ============================================================================
  # STAGE 2: Windows - All .NET Tests (Gated by Stage 1)
  # ============================================================================
  test-windows:
    name: "Stage 2: Windows Tests (.NET 5.0-10.0, Framework 4.6.2-4.8.1)"
    runs-on: windows-latest
    needs: [detect-projects, test-linux-core]
    if: github.repository != 'Chris-Wolfgang/repo-template' && needs.detect-projects.outputs.has-projects == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/head
          persist-credentials: false

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            5.0.x
            6.0.x
            7.0.x
            8.0.x
            9.0.x
            10.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Run all .NET tests (.NET 5.0-10.0 and Framework 4.6.2-4.8.1)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          
          $testProjects = @(Get-ChildItem -Path './tests/*' -Recurse -File -Include '*.csproj','*.vbproj','*.fsproj')
          
          if (@($testProjects).Count -eq 0) {
            Write-Error "‚ùå No test projects found in ./tests directory!"
            exit 1
          }
          
          Write-Host "==========================================" -ForegroundColor Cyan
          Write-Host "Found test projects:" -ForegroundColor Cyan
          Write-Host "==========================================" -ForegroundColor Cyan
          $testProjects | ForEach-Object { Write-Host $_.FullName -ForegroundColor White }
          Write-Host ""
          
          foreach ($testProj in $testProjects) {
            Write-Host "==========================================" -ForegroundColor Cyan
            Write-Host "Testing project: $($testProj.FullName)" -ForegroundColor Cyan
            Write-Host "==========================================" -ForegroundColor Cyan
            
            # Extract target frameworks from the project file
            # Support both <TargetFramework> (single) and <TargetFrameworks> (multiple)
            $content = Get-Content $testProj.FullName -Raw
            $tfmMatch = [regex]::Match($content, '<TargetFramework[s]?>([^<]+)</TargetFramework[s]?>')
            
            if (-not $tfmMatch.Success) {
              Write-Host "‚äò Skipping: No target frameworks found" -ForegroundColor Yellow
              Write-Host ""
              continue
            }
            
            # Split by semicolon for multi-targeting projects
            $frameworks = $tfmMatch.Groups[1].Value -split ';' | ForEach-Object { $_.Trim() } | Where-Object { $_ -match '^net(5\.0|6\.0|7\.0|8\.0|9\.0|10\.0|462|472|48|481)$' }
            
            if ($frameworks.Count -eq 0) {
              Write-Host "‚äò Skipping: No compatible .NET 5.0-10.0 or Framework 4.6.2-4.8.1 target frameworks found" -ForegroundColor Yellow
              Write-Host ""
              continue
            }
            
            Write-Host "Target frameworks: $($frameworks -join ', ')" -ForegroundColor White
            Write-Host ""
            
            # Test each framework that the project actually targets
            foreach ($fw in $frameworks) {
              Write-Host "Testing framework: $fw" -ForegroundColor Yellow
              
              dotnet test $testProj.FullName `
                --configuration Release `
                --framework $fw `
                --logger "console;verbosity=normal"
              
              if ($LASTEXITCODE -ne 0) {
                Write-Error "Tests failed for $fw in $($testProj.Name)"
                exit 1
              }
            }
            Write-Host ""
          }

  # ============================================================================
  # STAGE 3: macOS Tests (Gated by Stage 2)
  # ============================================================================
  test-macos-core:
    name: "Stage 3: macOS Tests (.NET 6.0-10.0)"
    runs-on: macos-latest
    needs: [detect-projects, test-windows]
    if: github.repository != 'Chris-Wolfgang/repo-template' && needs.detect-projects.outputs.has-projects == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/head
          persist-credentials: false

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            6.0.x
            7.0.x
            8.0.x
            9.0.x
            10.0.x

      - name: Restore and build (exclude .NET Framework-only projects)
        run: |
          echo "Enumerating tracked .NET project files (git ls-files)..."
          
          # Filter out projects that ONLY target .NET Framework 4.x
          # Multi-targeting projects (e.g., net8.0;net48) will be INCLUDED
          projects=()
          project_found=false
          
          while IFS= read -r -d '' proj; do
            project_found=true
            # Check if project has any .NET 6+ target framework (macOS ARM64 compatible)
            # Look for: net6.0, net7.0, net8.0, net9.0, net10.0
            if grep -qE '<TargetFramework[s]?>.*net(6\.0|7\.0|8\.0|9\.0|10\.0)' "$proj"; then
              projects+=("$proj")
              echo "‚úì Including: $proj (has .NET 6+ target)"
            else
              echo "‚äò Excluding: $proj (no .NET 6+ target, incompatible with macOS ARM64)"
            fi
          done < <(git ls-files -z -- '*.csproj' '*.vbproj' '*.fsproj')
          
          if [ "$project_found" = false ]; then
            echo "‚ùå No .NET projects found."
            echo "This should not occur as detect-projects already verified project existence."
            exit 1
          fi
          
          if [ ${#projects[@]} -eq 0 ]; then
            echo "‚ùå No compatible .NET projects found."
            echo "All projects lack .NET 6+ targets, which are required for macOS ARM64."
            exit 1
          fi
          
          echo ""
          echo "=========================================="
          echo "Projects to build (excluding .NET Framework-only projects):"
          echo "=========================================="
          printf '%s\n' "${projects[@]}"
          echo ""
          
          # Restore each project
          echo "Restoring projects..."
          for proj in "${projects[@]}"; do
            echo "Restoring: $proj"
            dotnet restore "$proj" || exit 1
          done
          
          echo ""
          echo "Building projects..."
          # Build each project, handling multi-targeting projects
          # For multi-targeting projects, build only macOS ARM64-compatible frameworks (net6.0-10.0)
          for proj in "${projects[@]}"; do
            echo "Building: $proj"
            
            # Extract target frameworks from the project file
            # Support both <TargetFramework> (single) and <TargetFrameworks> (multiple)
            # Trim whitespace from each framework before filtering
            frameworks=$(sed -n -E 's/.*<TargetFrameworks?>[[:space:]]*>([^<]+)<\/TargetFrameworks?>.*/\1/p' "$proj" | tr ';' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -E '^net(6\.0|7\.0|8\.0|9\.0|10\.0)$' || true)
            
            if [ -z "$frameworks" ]; then
              echo "‚ö†Ô∏è  No macOS ARM64-compatible frameworks found in $proj"
              continue
            fi
            
            # Check if this is a multi-targeting project
            framework_count=$(echo "$frameworks" | wc -l)
            
            if [ "$framework_count" -eq 1 ]; then
              # Single target framework - build normally
              echo "  Target framework: $frameworks"
              dotnet build "$proj" --no-restore --configuration Release || exit 1
            else
              # Multi-targeting project - build each compatible framework separately
              echo "  Target frameworks (multi-targeting): $(echo "$frameworks" | tr '\n' ' ')"
              while IFS= read -r fw; do
                [ -z "$fw" ] && continue
                echo "  Building framework: $fw"
                dotnet build "$proj" --no-restore --configuration Release --framework "$fw" || exit 1
              done <<< "$frameworks"
            fi
          done
          
          echo ""
          echo "‚úÖ All compatible projects built successfully"

      - name:  Run tests (.NET 6.0 - 10.0 only - ARM64 compatible)
        run: |
          # Find all test projects (C#, VB.NET, F#)
          mapfile -t test_projects < <(find ./tests -type f \( -name "*.csproj" -o -name "*.vbproj" -o -name "*.fsproj" \))
          
          if [ ${#test_projects[@]} -eq 0 ]; then
            echo "‚ùå No test projects found in ./tests directory!"
            exit 1
          fi
          
          echo "=========================================="
          echo "Found test projects:"
          echo "=========================================="
          printf '%s\n' "${test_projects[@]}"
          echo ""
          
          for test_proj in "${test_projects[@]}"; do
            echo "=========================================="
            echo "Testing project: $test_proj"
            echo "=========================================="
            
            # Extract target frameworks from the project file
            # Support both <TargetFramework> (single) and <TargetFrameworks> (multiple)
            # Only include .NET 6.0+ (ARM64 compatible on macOS)
            frameworks=$(grep -Eo '<TargetFrameworks?>[^<]+' "$test_proj" | sed -E 's/<TargetFrameworks?>//' | tr ';' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -E '^net(6\.0|7\.0|8\.0|9\.0|10\.0)$' || true)
            
            if [ -z "$frameworks" ]; then
              echo "‚äò Skipping: No compatible .NET 6.0-10.0 target frameworks found (ARM64 required)"
              echo ""
              continue
            fi
            
            echo "Target frameworks: $(echo "$frameworks" | tr '\n' ' ')"
            echo ""
            
            # Test each framework that the project actually targets
            while IFS= read -r fw; do
              [ -z "$fw" ] && continue
              echo "Testing framework: $fw"
              
              dotnet test "$test_proj" \
                --configuration Release \
                --framework "$fw" \
                --logger "console;verbosity=normal" || exit 1
            done <<< "$frameworks"
            echo ""
          done

      - name: Display macOS architecture info
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "‚ÑπÔ∏è  macOS Testing Notes"
          echo "=========================================="
          echo "Architecture: $(uname -m)"
          echo ""
          echo "Skipped frameworks (no ARM64 support):"
          echo "  - .NET 5.0 ‚ùå"
          echo ""
          echo "Tested frameworks (ARM64 compatible):"
          echo "  - .NET 6.0 ‚úÖ"
          echo "  - .NET 7.0 ‚úÖ"
          echo "  - .NET 8.0 ‚úÖ"
          echo "  - .NET 9.0 ‚úÖ"
          echo "  - .NET 10.0 ‚úÖ"
          echo ""
          echo ".NET Core 5.0 are tested on Linux and Windows"
          echo ""

      - name: Summarize pipeline result
        run: |
          echo "=========================================="
          echo "‚úÖ ALL STAGES PASSED"
          echo "=========================================="
          echo "Stage 1: Linux tests + 90% coverage ‚úÖ"
          echo "Stage 2: Windows .NET Core & .NET Framework tests ‚úÖ"
          echo "Stage 3: macOS tests ‚úÖ"
          echo ""
          echo "PR is ready to merge! üéâ"

  # ============================================================================
  # Security Scan (Runs in parallel, independently of .NET jobs)
  # ============================================================================
  security-scan:
    name: "Security Scan (DevSkim)"
    runs-on: ubuntu-latest
    if: github.repository != 'Chris-Wolfgang/repo-template'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/head
          persist-credentials: false

      - name: Install DevSkim CLI
        run: dotnet tool install --global Microsoft.CST.DevSkim.CLI

      - name: Run DevSkim security scan
        continue-on-error: true
        run: |
          devskim analyze \
            --source-code . \
            --file-format text \
            --output-file devskim-results.txt \
            -E \
            --ignore-rule-ids DS176209 \
            --ignore-globs "**/api/**,**/CoverageReport/**,**/TestResults/**"

      - name: Display security scan results
        if: always()
        run: |
          if [ -f devskim-results.txt ]; then
            echo "=========================================="
            echo "DevSkim Security Scan Results"
            echo "=========================================="
            cat devskim-results.txt
            echo ""
            
            if grep -qi "error\|critical\|high" devskim-results.txt; then
              echo "‚ö†Ô∏è Security issues detected - review required"
            else
              echo "‚úÖ No critical security issues found"
            fi
          else
            echo "‚úÖ No security issues found"
          fi

      - name: Upload security scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: devskim-results
          path: devskim-results.txt
          if-no-files-found: warn
